# 메모리 관련

## 힙사이즈 설정 방법 (broker, connect 공통)

- 필요한 상황이 아니면 default로 쓰면된다.
- `KAFKA_HEAP_OPTS="-Xms2G -Xmx2G"`와 같이 환경변수를 컨테이너로 넘겨준다. value파일에서 설정가능하다. min, max 값은 동일하게 한다.
- Broker에서 JVM 힙메모리는 통상 전체(컨테이너)리소스의 25%로 할당
  - 앱실행용 JVM보다 파일 I/O를 처리하는 별도 메모리가 많기 때문(top 명령어시 buff/cache로 출력되는 부분인데, 이는 힙메모리에 포함되지 않는 개념이다.)
  - 쿠버네티스에선 resources에서 컨테이너 메모리를 힙의 4배로 할당한다. `requests.memory`, `limits.memory` 값은 동일하게 한다.
- 빅데이터 처리 등 일부 분야에서 힙메모리를 `10GB 이상으로 쓰는게 아주 이상한 일은 아니다`.

## 트러블 슈팅

### 첫 실행시 메모리가 부족하진 않으나 조금씩 꾸준히 늘어나는 경우

- 메모리 누수` 가능성이 높음. 커넥터 등 플러그인의 개선 필요.
  
### 앱이 죽는 경우

- 힙 메모리 부족시, Container의 resources.limits에 도달하기도 전에 앱이 중지될 수 있다.

#### 대응방법

- JVM 힙메모리는 노드의 10\~50% 수준이 적정하지만, 필요에 따라 80\~90%까지 설정할 수 있다.
  - e.g. Connect에서 처리할 데이터 규모는 작은데 커넥션 개수만 많은 경우, JVM메모리는 많이 요구되지만 파일 I/O 용 메모리는 적게 요구되므로 힙 할당을 크게 가져가도된다.
  - JDBC Connector에서 DB 당 처리할 테이블이 100개 이상, 그러한 DB가 100개 이상, 총 커넥터 수는 400개 이상인 경우
  - 처리할 데이터가 많을 때는 `poll.interval.ms`를 줄여서 빠르게 데이터를 처리하면 메모리 부하 감소(broker는 buffer로 캐시메모리를 쓰지만, Connect는 buffer로 힙메모리를 사용함)
  - 처리할 데이터가 적을 때는 `poll.interval.ms`를 늘려서 신규 생성 로그 감지를 천천히하면 힙메모리 부하 감소
    - 특히 `task 수가 많은 경우 한 노드 내에서 컨텍스트 스위칭 비용이 커질 가능성`이 높다.
    - 이 경우 데이터처리속도를 감안하여 batch.max.rows도 함께 조정이 필요할 수 있음
- Connect 단독으로 노드를 사용하게 한다. resources.limit은 설정하지 않는다.
- (위 자원할당 방법들로 안되면) 스케일 업&아웃이나 별도 최적화된 Kafka Client앱을 만든다.
- [컨테이너 환경에서의 java 애플리케이션의 리소스와 메모리 설정](https://findstar.pe.kr/2022/07/10/java-application-memory-size-on-container/)

### 메모리 점유율이 높은 경우

- 메모리 점유율이 80~90%로 되어있다고 해서 항상 해당 규모의 메모리가 필요한 것은 아니다.
- 해당 앱에서 필요한 최대치라고 보면 된다. JVM은 한 번 사용했던 메모리를 반환하지 않고 계속 가지고 있기 때문.
- `jstat` 등으로 jvm 모니터링 시, 현재 실제 사용중인 정확한 메모리 확인 가능
- 특히 한 번에 많은 데이터를 kafka로 이전 시, 메모리가 과점유되는데 데이터 이전 완료 후 앱을 재실행해주면 좋다.

### 설정된 힙메모리와 실제 점유된 메모리가 다른경우

- 1) 설정된 힙메모리만큼 필요하지 않으면 점유하지 않음
  - 단 한번이라도 힙메모리 설정값만큼 점유하게 되면 이후 반환하지 않음
- 2) Kafka의 경우 파일 I/O 처리에 buff/cache 메모리를 사용하는데, 이는 모니터링 툴에 따라 다르게 보여준다.
  - `top`: buff/cache 메모리는 별도 표기됨
  - `htop`: buff/cache 메모리는 사실상 여유분으로 보고, 메모리 표기에 포함하지 않음
  - `kube-metric(kubectl, k9s)`: 사용되는 buff/cache 까지 포함하여 메모리 점유 표기

### 기타 메모리 이슈에서 최후의 방법

- 힙메모리 설정시 추가옵션으로 GC를 커스터마이징 한다!
- `linux-tips`레포지토리의 jvm 항목 참고
