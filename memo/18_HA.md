# Kafka 3대 구성에서 HA 구현

## 1. HA 구성 핵심 요소

- **Broker 수:** 최소 3대 (1대 장애 발생 시도 클러스터 운영 가능)
- **Replication Factor(RF):** 일반적으로 2 또는 3 설정
  - RF=2: 저장공간 절약 가능, 하지만 1대 장애 시 가용성 낮아질 수 있음
  - RF=3: 고가용성(HA) 보장, 1대 장애 시 무중단 처리 가능
- **min.insync.replicas (minISR, ISR 최소수)**: RF와 같거나 작야아하며, 보통 RF-1 값 권장 (예: RF=3이면 min.insync.replicas=2)
  - acks=all로 설정된 Producer의 "쓰기" 요청을 Broker가 최종 허용하기 위한 최소 ISR 개수
- **Leader/Follower (Replica):** 각 파티션마다 1개의 Leader, 나머지는 Follower로 구성되어 복제 동기화 유지

## 2. ISR(In-Sync Replicas) 개념

- **ISR:** Leader와 **동기화된 상태의 Follower replica 집합**
- 조건:
  - Leader와 최신 offset까지 동기화되어 있어야 함
  - 이 집합 안에 있는 replica만이 failover 시 Leader 승격 가능
- 장애 발생 시:
  - Leader 장애 → ISR 중 하나가 새 Leader로 자동 승격
  - ISR이 비어있거나 min.insync.replicas보다 적으면 produce 차단 가능

## 3. Producer `acks` 옵션

| 옵션 값 | 의미 |
|---------|------|
| `acks=0` | 전송하자마자 응답을 기다리지 않고, 전송 성공 취급 |
| `acks=1` | Leader에게 메시지가 잘 전송되었는지 확인함 |
| `acks=all` | 전송한 메시지가 클러스터 전반에 잘 복제되었는지 확인함 |

### **ack 옵션 별 동작 순서 상세**

- `acks=0`
  - Producer는 Leader로 메시지를 보내자마자 성공한 것으로 취급
  - Broker는 ack 반환하지 않음
  - (메시지 유실 위험성 큼)
- `acks=1`
  - Producer는 Leader로 메시지 전송 후 Leader의 ack를 기다린다.
  - Leader는 받은 메시지를 append(로컬에 저장)한 뒤 ack 반환
  - Producer는 ack를 받은 후 전송 성공으로 취급
  - (Leader 장애 시 유실 가능성 존재)
- `acks=all`
  - Producer는 Leader로 메시지 전송 후 Leader의 ack를 기다린다.
  - Leader는 받은 메시지를 append한다.
  - Follower들은 Leader로부터 해당 메시지를 복제한다. (fetch & append)
  - Leader가  **현재 ISR 전원**의 메시지 복제를 확인하면, Leader는 Producer로 ack를 보낸다.(복제여부는 Follower의 반복되는 fetch요청메시지를 통해 확인가능)
  - (유실 위험 거의 없음)

### `acks=all과 min.insync.replicas(minISR)의 연관성`

- acks=all의 성공 조건은 **모든 Replica가 아닌 현재 ISR 전원** 기준이다.
- 타이밍상 현재 ISR에 Leader만 있을 때(=ISR 크기 1)도 acks=all 조건 만족 가능
- 이를 방지하기 위해 minISR 값을 두어, 현재ISR 개수 < minISR이면 Producer의 쓰기 요청 자체를 실패로 반환

### `acks=all 성공판단 대상이 모든 Replica가 아닌 InSync-Replica(ISR)인 이유`

- Replica가 ISR에 포함되지 않는 경우, Leader에 비해 "동기화가 상당히 뒤처진 상태"라는 의미이기 때문에 현재 실시간 메시지 처리를 논할단계가 아니다.
- Producer에게 실시간 ack를 줘야하는데 뒤처진 Replica를 기다리고 있을 순 없다.

## 4. HA 구현 시 추천 설정

- replication.factor(RF)=3
- min.insync.replicas(minISR)=2
- acks=all
- Leader 자동 선출 활성화 (기본 설정)
- 브로커간 네트워크 안정성 확보 (동기화 지연시 ISR 축소될 수 있음)

## HA 구성시 신경 쓸 옵션들 & 조합 요약

- Kafka 설정(server.properties)에서

```yaml
  ########################################################
  # 모든 replications.factor 관련 설정 방법

  # 브로커 수: n
  # replications.factor 권장값: n-1
  # replications.factor 허용값: n과 같거나 작아야 함 && 최소 1
  
  # 이미 생성된 topic의 replication.factor는 여기서 변경불가. kafka-reassign-partitions.sh 스크립트를 사용하여 수동변경 가능.
  # 중요한 topic일 수록 replication.factor가 크면 좋음(e.g. __consumer_offset, connect-offset 등 연결정보 토픽)
  ########################################################
  # __consumer_offset의 복제 수 (default: 3)
  offsets.topic.replication.factor: 3
  # 신규생성 토픽의 파티션 수  (default: 1)
  num.partitions: 3
  # 신규생성 토픽의 복제 수    (default: 1)
  default.replication.factor: 2
```

- 개별 Topic 에서
  - replication.factor=3(RF)
  - min.insync.replicas=2 (minISR)
  - unclean.leader.election.enable
    - default: false (권장)
    - ISR에 해당하는 파티션 레플리카가 죽었을 떄, ISR을 불만족하는(복제완료되지 않은) 레플리카를 새 리더로 선출할지 여부를 정함
    - 보통은 false로 하면되고, default도 false라 크게 신경쓸 필요 없음
    - true시 가용성은 좋지만, 데이터 손실 위험이 있음
    - 데이터 무결성이 중요하지 않은 실시간성/캐시성 데이터 처리 용도로 Kafka를 쓸 때만 true하면됨
- Producer에서
  - acks=all (고가용성을 위해 권장)
  - acks=1
